# Mini-KVM: 교육용 x86 하이퍼바이저

## 연구 정보

| 항목 | 내용 |
|------|------|
| **연구주제** | Linux KVM API를 활용한 교육용 x86 하이퍼바이저 개발 |
| **학번** | 202322071 |
| **이름** | 설규원 |
| **지도교수** | 김상훈 |
| **개발기간** | 2025년 9월 ~ 2025년 12월 (16주) |

---

## 목차

1. [요약](#1-요약)
2. [개요](#2-개요)
3. [연구 배경 및 목표](#3-연구-배경-및-목표)
4. [시스템 설계](#4-시스템-설계)
5. [구현 내용](#5-구현-내용)
6. [연구 결과](#6-연구-결과)
7. [결론 및 향후 연구](#7-결론-및-향후-연구)
8. [출처](#8-출처)

---

## 1. 요약

본 연구에서는 Linux KVM(Kernel-based Virtual Machine) API를 활용하여 교육용 x86 하이퍼바이저 "Mini-KVM"을 개발하였다. 약 4,000줄의 C 코드로 구현된 이 하이퍼바이저는 다중 vCPU 지원, 리얼 모드(16비트) 및 보호 모드(32비트) 게스트 실행, 인터럽트 처리, 하이퍼콜 인터페이스 등 핵심 가상화 개념을 성공적으로 시연한다.

**주요 성과:**
- 최대 4개의 vCPU를 동시에 실행하는 다중 가상 CPU 지원
- 8개의 리얼 모드 게스트 프로그램 개발
- 9개의 대화형 프로그램을 포함한 보호 모드 운영체제 "1K OS" 개발
- 타이머 및 키보드 인터럽트 처리 구현
- Linux 커널 부팅 성공 (initramfs 기반 userspace shell 진입)
- QEMU TCG 에뮬레이션 대비 50-100배 성능 향상

---

## 2. 개요

### 2.1 프로젝트 소개

Mini-KVM은 하드웨어 가상화 기술의 핵심 원리를 학습하고 이해하기 위한 교육용 하이퍼바이저이다. 상용 하이퍼바이저(QEMU, VirtualBox, VMware)와 달리, 핵심 기능만을 최소한의 코드로 구현하여 가상화 기술의 본질을 명확히 파악할 수 있도록 설계하였다.

### 2.2 프로젝트 구조

```
mini-kvm/
├── kvm-vmm-x86/          # 핵심 VMM 프로젝트
│   ├── src/              # VMM 소스코드 (C)
│   ├── guest/            # 리얼 모드 게스트 프로그램 (x86 어셈블리)
│   └── os-1k/            # 1K OS - 보호 모드 게스트 (C + 어셈블리)
├── docs/                 # 문서
├── research/             # 주간 연구 노트 (16주)
└── meetings/             # 교수님 미팅 기록 (12회)
```

---

## 3. 연구 배경 및 목표

### 3.1 연구 배경

현대 클라우드 컴퓨팅의 핵심 기술인 가상화는 하드웨어 자원의 효율적 활용을 가능하게 한다. Intel VT-x, AMD-V와 같은 하드웨어 가상화 확장 기능이 도입되면서, 소프트웨어 기반 에뮬레이션보다 훨씬 효율적인 가상화가 가능해졌다. Linux KVM은 이러한 하드웨어 가상화를 리눅스 커널에서 직접 지원하는 모듈로, 업계 표준으로 자리잡았다.

그러나 기존의 가상화 소프트웨어(QEMU 등)는 코드가 방대하여(수십만 줄) 학습 목적으로 접근하기 어렵다. 본 연구는 KVM의 핵심 API만을 활용하여 최소한의 기능으로 완전히 동작하는 하이퍼바이저를 구현함으로써 가상화 기술의 핵심 원리를 학습하고자 하였다.

### 3.2 연구 목표

1. **KVM API 학습**: Linux KVM의 ioctl 기반 인터페이스 이해
2. **x86 아키텍처 이해**: 리얼 모드, 보호 모드, 세그멘테이션, 페이징 등
3. **하이퍼바이저 구현**: VM 생성, vCPU 관리, 메모리 관리, I/O 에뮬레이션
4. **게스트 OS 개발**: 하이퍼바이저 위에서 동작하는 간단한 운영체제 구현
5. **Linux 부팅 도전**: 실제 Linux 커널을 게스트로 부팅

---

## 4. 시스템 설계

### 4.1 전체 아키텍처

```
┌─────────────────────────────────────────────┐
│           사용자 공간 (호스트)              │
│  ┌───────────────────────────────────────┐  │
│  │  Mini-KVM VMM (main.c)                │  │
│  │  - VM 생성 및 관리                    │  │
│  │  - vCPU 스레드 (pthreads)             │  │
│  │  - I/O 처리 (UART, 하이퍼콜)          │  │
│  │  - 인터럽트 주입                      │  │
│  └───────────────────────────────────────┘  │
│              ↕ KVM ioctl()                  │
├─────────────────────────────────────────────┤
│           커널 공간 (호스트)                │
│  ┌───────────────────────────────────────┐  │
│  │  Linux KVM 모듈                       │  │
│  │  - 하드웨어 가상화 (Intel VT-x)       │  │
│  │  - VM exit 처리                       │  │
│  │  - 메모리 관리 (EPT)                  │  │
│  └───────────────────────────────────────┘  │
├─────────────────────────────────────────────┤
│           게스트 (가상 머신)                │
│  ┌───────────────────────────────────────┐  │
│  │  리얼 모드 / 보호 모드 / Linux 커널   │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

### 4.2 VMM 핵심 구성요소

| 구성요소 | 설명 | 코드량 |
|----------|------|--------|
| VM 초기화 | /dev/kvm을 통한 VM 생성, 메모리 설정 | ~150줄 |
| vCPU 관리 | pthread 기반 vCPU별 스레드 모델 | ~300줄 |
| 메모리 관리 | 게스트 페이지 테이블, 4MB PSE 페이지 | ~100줄 |
| 하이퍼콜 인터페이스 | I/O 포트 0x500을 통한 게스트-호스트 통신 | ~200줄 |
| 인터럽트 주입 | 타이머(IRQ0), 키보드(IRQ1) | ~250줄 |
| VM Exit 처리 | MMIO, PIO, HLT 명령어 처리 | ~400줄 |

---

## 5. 구현 내용

### 5.1 리얼 모드 게스트 (8개)

| 프로그램 | 설명 | 크기 |
|----------|------|------|
| minimal.bin | 가장 간단한 HLT 명령어 게스트 | 1 byte |
| hello.bin | "Hello, KVM!" 출력 | ~50 bytes |
| counter.bin | 0부터 9까지 카운트 | ~30 bytes |
| multiplication.bin | 구구단 출력 (하이퍼콜 이용) | ~110 bytes |
| multiplication_short.bin | 간단한 구구단 (2-4단) | ~80 bytes |
| fibonacci.bin | 피보나치 수열 생성 | ~60 bytes |
| matrix.bin | 행렬 연산 데모 | ~100 bytes |
| hctest.bin | 하이퍼콜 테스트 | ~40 bytes |

### 5.2 보호 모드 게스트 - 1K OS

GDT/IDT 설정, 4MB 페이징, 인터럽트 핸들러를 갖춘 32비트 운영체제로, 9개의 대화형 프로그램을 제공한다:

1. **구구단** - 2단 ~ 9단 출력
2. **카운터** - 0~9 카운트
3. **에코** - 대화형 입출력
4. **피보나치** - 처음 15개 숫자
5. **소수** - 100까지의 소수
6. **계산기** - 사칙연산 (+, -, *, /)
7. **팩토리얼** - 0! ~ 12!
8. **최대공약수** - 유클리드 호제법
9. **1K OS 정보** - 시스템 정보 출력

### 5.3 Linux 커널 부팅 (추가 연구)

Week 14-16에 걸쳐 실제 Linux 커널 부팅을 시도하여 성공하였다:

- **boot_params 레이아웃 수정**: Linux boot protocol의 정확한 오프셋 준수
- **initrd 적재 위치 최적화**: 커널 footprint와의 충돌 방지
- **UART IRQ 에뮬레이션**: userspace I/O를 위한 COM1 IRQ4 지원
- **최소 initramfs 구축**: bash 기반 shell 환경 제공

**재현 명령:**
```bash
./kvm-vmm --linux ./bzImage --initrd ./initramfs.cpio \
  --cmdline "console=ttyS0 earlycon=uart,io,0x3f8,115200 loglevel=4 nokaslr"
```

---

## 6. 연구 결과

### 6.1 정량적 성과

| 항목 | 수치 |
|------|------|
| 총 코드량 (VMM) | ~4,000줄 (C) |
| 게스트 프로그램 | 17개 (8 리얼모드 + 9 보호모드) |
| 지원 vCPU 수 | 최대 4개 동시 실행 |
| 연구 기간 | 16주 |
| 교수님 미팅 | 12회 |
| 성능 향상 | QEMU TCG 대비 50-100배 |

### 6.2 정성적 성과

1. **교육적 가치**: 복잡한 상용 하이퍼바이저를 단순화하여 가상화 핵심 개념 학습 가능
2. **완전한 기능**: 최소한의 코드로 실제 동작하는 하이퍼바이저 구현
3. **확장 가능성**: Long Mode(64비트) 지원 기반 구축
4. **실용적 검증**: Linux 커널 부팅 성공으로 실제 활용 가능성 입증

### 6.3 주요 해결 과제

| 문제 | 원인 | 해결 방법 |
|------|------|----------|
| 리얼모드 게스트 Hang | 불필요한 IRQCHIP 활성화 | 모드별 조건부 IRQCHIP 생성 |
| Linux 부팅 실패 | boot_params 레이아웃 불일치 | 정확한 오프셋 매핑 및 검증 |
| userspace 출력 안됨 | UART IRQ 미구현 | COM1 IRQ4 에뮬레이션 추가 |

---

## 7. 결론 및 향후 연구

### 7.1 결론

본 연구를 통해 Linux KVM API를 활용한 교육용 하이퍼바이저를 성공적으로 개발하였다. 약 4,000줄의 간결한 코드로 다중 vCPU, 리얼/보호 모드 게스트, 인터럽트 처리, 하이퍼콜 인터페이스 등 핵심 가상화 기능을 구현하였으며, 실제 Linux 커널 부팅까지 성공하여 실용성을 검증하였다.

이 프로젝트는 복잡한 가상화 기술을 학습하고자 하는 학생들에게 좋은 시작점이 될 수 있으며, 코드가 공개되어 누구나 참고하고 확장할 수 있다.

### 7.2 향후 연구

**단기 목표 (1-2주):**
- 전체 키보드 스캔코드 지원
- 간단한 블록 디바이스 에뮬레이션

**중장기 목표 (1-2개월):**
- Long Mode (64비트) 게스트 지원
- 그래픽 출력 (프레임버퍼)
- 네트워크 인터페이스 (TAP 디바이스)
- 게스트 SMP 지원 (공유 메모리, IPI)

---

## 8. 출처

### 8.1 공식 문서

1. **Linux KVM API Documentation**
   - https://www.kernel.org/doc/html/latest/virt/kvm/api.html

2. **Intel Software Developer's Manual**
   - Vol. 3C: Intel 64 and IA-32 Architectures Software Developer's Manual, Chapter 23-33 (VMX)

3. **Linux Boot Protocol**
   - https://www.kernel.org/doc/html/latest/arch/x86/boot.html

### 8.2 참고 프로젝트

1. **kvmtool** - Lightweight KVM host tool
   - https://github.com/kvmtool/kvmtool

2. **Firecracker** - Secure microVM
   - https://github.com/firecracker-microvm/firecracker

3. **Bochs** - x86 emulator (구조 참고)
   - https://bochs.sourceforge.io/

### 8.3 학습 자료

1. **"Hardware and Software Support for Virtualization"** - Edouard Bugnion et al.
2. **xv6 Operating System** - MIT PDOS
   - https://github.com/mit-pdos/xv6-public

---

*본 결과보고서는 아주대학교 개인연구 프로젝트의 일환으로 작성되었습니다.*

*Repository: https://github.com/seolcu/mini-kvm*
